import type { LoaderContext } from "../../types/config.js"

export default async function cssLoader(
    source: string,
    sourceMap: any,
    context: LoaderContext
): Promise<string> {
    try {
        // ç®€å•çš„CSSå¤„ç†ï¼šå°†CSSè½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶å¯¼å‡º
        const escapedCSS = source
            .replace(/\\/g, '\\\\')
            .replace(/`/g, '\\`')
            .replace(/\$/g, '\\$')

        // ç”ŸæˆJavaScriptæ¨¡å—ä»£ç 
        const moduleCode = `
// CSS Module generated by css-loader
const css = \`${escapedCSS}\`;

// å¦‚æœåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œè‡ªåŠ¨æ’å…¥æ ·å¼
if (typeof document !== 'undefined') {
    const style = document.createElement('style');
    style.textContent = css;
    document.head.appendChild(style);
}

export default css;
export { css };
`

        console.log(`ğŸ¨ CSSè½¬æ¢å®Œæˆ: ${context.resourcePath}`)
        return moduleCode.trim()

    } catch (error: any) {
        console.error(`âŒ CSS Loaderå¤„ç†å¤±è´¥: ${context.resourcePath}`, error)
        throw new Error(`CSS Loader failed: ${error.message}`)
    }
} 